rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Users can only read/write their own document
      allow read: if request.auth.uid == userId;
      allow write: if request.auth.uid == userId && 
                      validateUserDocument(resource.data);

      // Helper function to validate user document structure
      function validateUserDocument(data) {
        return data.size() > 0 &&
               data.keys().hasAll(['uid', 'email', 'displayName', 'coins', 
                                   'dailyStreak', 'referralCode', 'createdAt']);
      }

      // Coin Transactions Subcollection
      match /coin_transactions/{transaction} {
        allow read: if request.auth.uid == userId;
        allow write: if request.auth.uid == userId &&
                        request.resource.data.size() <= 5 &&
                        request.resource.data.keys().hasAll(['amount', 'reason', 'timestamp']);
      }

      // Game History Subcollection
      match /game_history/{gameId} {
        allow read: if request.auth.uid == userId;
        allow write: if request.auth.uid == userId &&
                        validateGameHistory(request.resource.data);
      }

      // Withdrawal Requests Subcollection
      match /withdrawal_requests/{withdrawalId} {
        allow read: if request.auth.uid == userId;
        allow write: if request.auth.uid == userId &&
                        validateWithdrawalRequest(request.resource.data);
      }

      // Action Queue Subcollection (offline actions)
      match /action_queue/{actionId} {
        allow read: if request.auth.uid == userId;
        allow write: if request.auth.uid == userId &&
                        validateActionQueue(request.resource.data);
      }
    }

    // ============================================
    // REFERRAL CODES COLLECTION
    // ============================================
    match /referral_codes/{codeId} {
      // Anyone can read referral code info
      allow read: if request.auth != null;
      // Only system (via transaction) can write
      allow write: if false; // No direct writes, only via transactions
    }

    // ============================================
    // WITHDRAWALS COLLECTION (Admin Only for writes)
    // ============================================
    match /withdrawals/{withdrawalId} {
      // Users can read their own withdrawals
      allow read: if request.auth != null && 
                     (request.auth.uid == resource.data.userId || 
                      isAdmin(request.auth.uid));
      // Users can create (their own), admins can update status
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.userId &&
                       validateWithdrawalRequest(request.resource.data);
      allow update: if isAdmin(request.auth.uid) &&
                       validateWithdrawalUpdate(resource.data, request.resource.data);
    }

    // ============================================
    // GAME HISTORY COLLECTION (For analytics/stats)
    // ============================================
    match /game_history/{gameId} {
      // Users can read all games
      allow read: if request.auth != null;
      // Only users can create their own game history
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.userId &&
                       validateGameHistory(request.resource.data);
    }

    // ============================================
    // REFERRAL RECORDS COLLECTION
    // ============================================
    match /referral_records/{recordId} {
      // Users can read their referral records
      allow read: if request.auth != null &&
                     (request.auth.uid == resource.data.referrerUserId ||
                      request.auth.uid == resource.data.referredUserId);
      // Only system can write
      allow write: if false;
    }

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Validate Game History Document
    function validateGameHistory(data) {
      return data.size() >= 5 &&
             data.keys().hasAll(['userId', 'gameName', 'isWon', 'coinsEarned', 'playedAt']) &&
             data.gameName is string &&
             data.isWon is bool &&
             data.coinsEarned is number &&
             data.coinsEarned >= 0 &&
             data.playedAt is timestamp;
    }

    // Validate Withdrawal Request
    function validateWithdrawalRequest(data) {
      return data.size() >= 7 &&
             data.keys().hasAll(['userId', 'amount', 'paymentMethod', 
                                'paymentDetails', 'status', 'requestedAt']) &&
             data.amount is number &&
             data.amount >= 100 &&
             data.amount <= 100000 &&
             (data.paymentMethod == 'UPI' || data.paymentMethod == 'BANK_TRANSFER') &&
             data.paymentDetails is string &&
             data.paymentDetails.size() > 0 &&
             (data.status == 'PENDING' || data.status == 'APPROVED' || data.status == 'REJECTED') &&
             data.requestedAt is timestamp;
    }

    // Validate Withdrawal Update (for admin approval)
    function validateWithdrawalUpdate(oldData, newData) {
      return oldData.status == 'PENDING' &&
             (newData.status == 'APPROVED' || newData.status == 'REJECTED') &&
             newData.processedAt is timestamp &&
             (newData.status == 'REJECTED' ? (newData.rejectionReason is string) : true);
    }

    // Validate Action Queue Item
    function validateActionQueue(data) {
      return data.size() >= 5 &&
             data.keys().hasAll(['userId', 'actionType', 'coinsChange', 'createdAt']) &&
             (data.actionType == 'GAME_WON' || 
              data.actionType == 'AD_WATCHED' || 
              data.actionType == 'SPIN' || 
              data.actionType == 'REFERRAL_BONUS') &&
             data.coinsChange is number &&
             data.createdAt is timestamp;
    }

    // Check if user is admin
    function isAdmin(uid) {
      return get(/databases/$(database)/documents/admins/$(uid)).data.isAdmin == true;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
